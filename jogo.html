<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Santa Teresinha Idle</title>
<style>
body{
    margin:0;
    background:#111;
    overflow:hidden;
}
canvas{
    display:block;
    margin:auto;
    background:black;
    image-rendering:pixelated;
    cursor:grab;
}
canvas:active{
    cursor:grabbing;
}
</style>
</head>
<body>
<canvas id="game"></canvas>

<script>

// ===============================
// CONFIGURAÇÃO
// ===============================

const TILE = 32;
const MAP_WIDTH = 100;   // mapa maior
const MAP_HEIGHT = 100;

const VIEW_WIDTH = 40;   // tamanho da tela
const VIEW_HEIGHT = 25;

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

canvas.width = VIEW_WIDTH * TILE;
canvas.height = VIEW_HEIGHT * TILE;

ctx.imageSmoothingEnabled = false;


// ===============================
// CÂMERA (ARRASTAR MAPA)
// ===============================

let camera = {
    x: 0,
    y: 0
};

let dragging = false;
let lastMouse = {x:0,y:0};

canvas.addEventListener("mousedown", (e)=>{
    dragging = true;
    lastMouse.x = e.clientX;
    lastMouse.y = e.clientY;
});

canvas.addEventListener("mouseup", ()=> dragging = false);
canvas.addEventListener("mouseleave", ()=> dragging = false);

canvas.addEventListener("mousemove", (e)=>{
    if(!dragging) return;

    let dx = e.clientX - lastMouse.x;
    let dy = e.clientY - lastMouse.y;

    camera.x -= dx;
    camera.y -= dy;

    // limites do mapa
    camera.x = Math.max(0, Math.min(camera.x, MAP_WIDTH*TILE - canvas.width));
    camera.y = Math.max(0, Math.min(camera.y, MAP_HEIGHT*TILE - canvas.height));

    lastMouse.x = e.clientX;
    lastMouse.y = e.clientY;
});


// ===============================
// IMAGENS
// ===============================

const imagens = {
    gramas: [],
    biblioteca: new Image()
};

// 5 gramas
for(let i=1;i<=5;i++){
    let img = new Image();
    img.src = `grama${i}.jpg`;
    imagens.gramas.push(img);
}

imagens.biblioteca.src = "biblioteca.png";


// ===============================
// MAPA ORGÂNICO
// ===============================

const mapaGrama = [];

for(let y=0;y<MAP_HEIGHT;y++){
    mapaGrama[y] = [];
    for(let x=0;x<MAP_WIDTH;x++){

        let r = Math.random();
        let tipo = 0;

        if(r < 0.6) tipo = 0;
        else if(r < 0.75) tipo = 1;
        else if(r < 0.85) tipo = 2;
        else if(r < 0.93) tipo = 3;
        else tipo = 4;

        mapaGrama[y][x] = {
            tipo: tipo,
            sombra: Math.random()*0.07
        };
    }
}


// ===============================
// OBJETOS
// ===============================

const objetos = [
    { tipo:"biblioteca", x:50, y:50, largura:4, altura:4 }
];


// ===============================
// DESENHAR CHÃO
// ===============================

function desenharChao(){

    const startX = Math.floor(camera.x / TILE);
    const startY = Math.floor(camera.y / TILE);

    const endX = startX + VIEW_WIDTH + 1;
    const endY = startY + VIEW_HEIGHT + 1;

    for(let y=startY;y<endY;y++){
        for(let x=startX;x<endX;x++){

            if(x<0 || y<0 || x>=MAP_WIDTH || y>=MAP_HEIGHT) continue;

            const tile = mapaGrama[y][x];
            const img = imagens.gramas[tile.tipo];

            const drawX = x*TILE - camera.x;
            const drawY = y*TILE - camera.y;

            if(img.complete && img.naturalWidth !== 0){
                ctx.drawImage(img, drawX, drawY, TILE, TILE);

                ctx.fillStyle = `rgba(0,0,0,${tile.sombra})`;
                ctx.fillRect(drawX, drawY, TILE, TILE);
            }
            else{
                ctx.fillStyle = "#2ecc71";
                ctx.fillRect(drawX, drawY, TILE, TILE);
            }
        }
    }
}


// ===============================
// DESENHAR OBJETOS
// ===============================

function desenharObjetos(){

    objetos.forEach(obj=>{

        const drawX = obj.x*TILE - camera.x;
        const drawY = obj.y*TILE - camera.y;

        ctx.fillStyle = "rgba(0,0,0,0.25)";
        ctx.fillRect(
            drawX,
            drawY + obj.altura*TILE - 8,
            obj.largura*TILE,
            8
        );

        if(obj.tipo==="biblioteca" &&
           imagens.biblioteca.complete &&
           imagens.biblioteca.naturalWidth !== 0){

            ctx.drawImage(
                imagens.biblioteca,
                drawX,
                drawY,
                obj.largura*TILE,
                obj.altura*TILE
            );
        }
        else{
            ctx.fillStyle="#3498db";
            ctx.fillRect(drawX,drawY,obj.largura*TILE,obj.altura*TILE);
        }

    });
}


// ===============================
// LOOP
// ===============================

function loop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    desenharChao();
    desenharObjetos();
    requestAnimationFrame(loop);
}

loop();

</script>
</body>
</html>
