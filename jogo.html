<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Santa Teresinha Idle</title>
<style>
body{
    margin:0;
    background:#111;
    overflow:hidden;
}
canvas{
    display:block;
    background:black;
    image-rendering:pixelated;
    cursor:grab;
}
canvas:active{
    cursor:grabbing;
}
</style>
</head>
<body>
<canvas id="game"></canvas>

<script>

// =====================================
// CONFIG
// =====================================

const TILE = 32;
const MAP_WIDTH = 100;
const MAP_HEIGHT = 100;

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
ctx.imageSmoothingEnabled = false;


// =====================================
// CANVAS RESPONSIVO
// =====================================

function resizeCanvas(){
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

    
// =====================================
// ZOOM (APENAS SCROLL)
// =====================================

let zoom = 1;

canvas.addEventListener("wheel", (e)=>{
    e.preventDefault();

    const zoomSpeed = 0.0015;
    zoom -= e.deltaY * zoomSpeed;
    zoom = Math.max(0.5, Math.min(3, zoom));
});

// =====================================
// CÂMERA ARRASTÁVEL
// =====================================

let camera = {
    x: MAP_WIDTH * TILE / 2 - canvas.width / 2,
    y: MAP_HEIGHT * TILE / 2 - canvas.height / 2
};

let dragging = false;
let lastMouse = { x:0, y:0 };

canvas.addEventListener("contextmenu", e => e.preventDefault());

canvas.addEventListener("mousedown", e=>{
    if(e.button !== 2) return;
    dragging = true;
    lastMouse.x = e.clientX;
    lastMouse.y = e.clientY;
});

window.addEventListener("mouseup", ()=> dragging=false);

window.addEventListener("mousemove", e=>{
    if(!dragging) return;

    let dx = e.clientX - lastMouse.x;
    let dy = e.clientY - lastMouse.y;

    camera.x -= dx / zoom;
    camera.y -= dy / zoom;

    camera.x = Math.max(0, Math.min(camera.x, MAP_WIDTH*TILE - canvas.width/zoom));
    camera.y = Math.max(0, Math.min(camera.y, MAP_HEIGHT*TILE - canvas.height/zoom));

    lastMouse.x = e.clientX;
    lastMouse.y = e.clientY;
});


// =====================================
// IMAGENS
// =====================================

const imagens = {
    gramas: [],
    mesa: new Image(),
    cadeiraEsq: new Image(),
    cadeiraDir: new Image(),
    biblioteca: new Image(),
    estrada: new Image()
};

let imagensParaCarregar = 0;
let imagensCarregadas = 0;

function imagemCarregada(){
    imagensCarregadas++;
    if(imagensCarregadas === imagensParaCarregar){
        loop();
    }
}

function registrarImagem(img){
    imagensParaCarregar++;
    img.onload = imagemCarregada;
}

// gramas
for(let i=1;i<=5;i++){
    let img = new Image();
    registrarImagem(img);
    img.src = `grama${i}.jpg`;
    imagens.gramas.push(img);
}

// objetos
registrarImagem(imagens.mesa);
registrarImagem(imagens.cadeiraEsq);
registrarImagem(imagens.cadeiraDir);
registrarImagem(imagens.biblioteca);
registrarImagem(imagens.estrada);

imagens.estrada.src = "tiles/ti.png";
imagens.mesa.src = "mesa.png";
imagens.cadeiraEsq.src = "cadeira_esquerda.png";
imagens.cadeiraDir.src = "cadeira_direita.png";
imagens.biblioteca.src = "bb.png";


// =====================================
// MAPA
// =====================================

const mapaGrama = [];

const centroX = Math.floor(MAP_WIDTH / 2);
const centroY = Math.floor(MAP_HEIGHT / 2);

const escolaY = 12;
const largura = 1;

for(let y = 0; y < MAP_HEIGHT; y++){
    mapaGrama[y] = [];

    for(let x = 0; x < MAP_WIDTH; x++){

        let tipo = 0;

        if(y >= centroY - largura && y <= centroY + largura) tipo = 5;
        if(x >= centroX - largura && x <= centroX + largura) tipo = 5;

        if(y >= escolaY - largura && y <= escolaY + largura) tipo = 5;

        if(
            x >= centroX - largura &&
            x <= centroX + largura &&
            y >= Math.min(escolaY, centroY) &&
            y <= Math.max(escolaY, centroY)
        ){
            tipo = 5;
        }

        mapaGrama[y][x] = {
            tipo: tipo,
            sombra: Math.random() * 0.03
        };
    }
}

// =====================================
// OBJETOS
// =====================================

const centroTileX = 50;
const centroTileY = 50;

const objetos = [
    {
        tipo:"biblioteca",
        tileX: 7,
        tileY: 12,
        escala: 0.9,
        layer: 0
    },
    {
        tipo:"cadeiraEsq",
        tileX: centroTileX - 1.77,
        tileY: centroTileY - 0.20,
        escala: 0.22,
        layer: 0
    },
    {
        tipo:"cadeiraDir",
        tileX: centroTileX + 1.77,
        tileY: centroTileY - 0.20,
        escala: 0.22,
        layer: 0
    },
    {
        tipo:"mesa",
        tileX: centroTileX,
        tileY: centroTileY,
        escala: 0.42,
        layer: 1
    }
];

// =====================================
// DESENHAR CHÃO
// =====================================

function desenharChao(){

    const startX = Math.floor(camera.x / TILE);
    const startY = Math.floor(camera.y / TILE);

    const viewWidth = Math.ceil(canvas.width / TILE);
    const viewHeight = Math.ceil(canvas.height / TILE);

    const endX = startX + viewWidth + 2;
    const endY = startY + viewHeight + 2;

    for(let y=startY;y<endY;y++){
        for(let x=startX;x<endX;x++){

            if(x<0 || y<0 || x>=MAP_WIDTH || y>=MAP_HEIGHT) continue;

            const tile = mapaGrama[y][x];
            let img = tile.tipo === 5 ? imagens.estrada : imagens.gramas[tile.tipo];

            const drawX = x*TILE;
            const drawY = y*TILE;

            if(img && img.complete && img.naturalWidth !== 0){

                ctx.drawImage(img, drawX, drawY, TILE, TILE);

                ctx.fillStyle = `rgba(0,0,0,${tile.sombra})`;
                ctx.fillRect(drawX, drawY, TILE, TILE);

            }
        }
    }
}

// =====================================
// DESENHAR OBJETOS
// =====================================

function desenharObjetos(){

    objetos.sort((a,b)=>{
        if(a.layer !== b.layer) return a.layer - b.layer;
        return (a.tileY - b.tileY);
    });

    objetos.forEach(obj=>{

        const img = imagens[obj.tipo];
        if(!img.complete) return;

        const largura = img.width * obj.escala;
        const altura = img.height * obj.escala;

        const baseX = obj.tileX * TILE + TILE/2;
        const baseY = obj.tileY * TILE + TILE;

        ctx.fillStyle = "rgba(0,0,0,0.25)";
        ctx.fillRect(baseX-largura/4, baseY-3, largura/2, 5);

        ctx.drawImage(
            img,
            baseX-largura/2,
            baseY-altura,
            largura,
            altura
        );
    });
}

// =====================================
// LOOP
// =====================================

function loop(){

    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.setTransform(
        zoom, 0,
        0, zoom,
        -camera.x * zoom,
        -camera.y * zoom
    );

    desenharChao();
    desenharObjetos();

    ctx.setTransform(1,0,0,1,0,0);

    requestAnimationFrame(loop);
}

</script>
</body>
</html>
